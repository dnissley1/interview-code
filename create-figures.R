# load required packages

library(dplyr)
library(readr)
library(ggplot2)

# read in the results generated by entanglement-assoc-pathways.R
results <- readr::read_delim("processed-data/analysis_results.csv")

# select subset of pathways that are enriched and save results
enriched <- results %>%
            dplyr::filter(odds_ratios > 1.0 & 
                          odds_ratios != Inf &
                          corrected_p_values < 0.05 & 
                          enrich_p_values < 0.05)

dim(enriched)
readr::write_csv(enriched, "processed-data/enriched.csv")

# select subset of pathways that are depleted and save results
depleted <- results %>%
            dplyr::filter(odds_ratios < 1.0 & 
                          odds_ratios > 0.0 &
                          corrected_p_values < 0.05 &
                          deplete_p_values < 0.05)

dim(depleted)
readr::write_csv(depleted, "processed-data/depleted.csv")

# select subset of 10 enriched/depleted pathways for plotting
sorted_enriched_subset <- arrange(enriched, desc(odds_ratios)) %>% 
                          head(10)
sorted_depleted_subset <- arrange(depleted, desc(odds_ratios)) %>% 
                          head(10)

# create two barplots of a subset of the results and save them
ggplot(sorted_enriched_subset, 
       aes(x = reorder(unique_pathways, -odds_ratios), 
           y = odds_ratios)) + 
       geom_bar(stat = "identity", 
                fill = "red") + 
       theme(legend.position = "none", 
             axis.text.x = element_text(angle = 90),
             axis.title.x = element_blank()) + 
       ylab("Odds Ratio")

ggsave("figures/enriched_ORs_top10.png")

ggplot(sorted_depleted_subset, 
       aes(x = reorder(unique_pathways, -odds_ratios), 
           y = odds_ratios)) + 
       geom_bar(stat = "identity", 
                fill = "blue") + 
       theme(legend.position = "none", 
             axis.text.x = element_text(angle = 90),
             axis.title.x = element_blank()) + 
       ylab("Odds Ratio")

ggsave("figures/depleted_ORs.png")

# create mosaic plots of one enriched pathway's results and one depleted
# pathway's results

# enriched
enr_pathway <- "R-HSA-72203"
enr_a <- enriched %>% 
         dplyr::filter(unique_pathways == enr_pathway) %>%
         .$a_in_pathway_entangled

enr_b <- enriched %>% 
         dplyr::filter(unique_pathways == enr_pathway) %>%
         .$b_out_pathway_entangled

enr_c <- enriched %>% 
         dplyr::filter(unique_pathways == enr_pathway) %>%
         .$c_in_pathway_not_entangled

enr_d <- enriched %>% 
         dplyr::filter(unique_pathways == enr_pathway) %>%
         .$d_out_pathway_not_entangled

enr_matrix           <- matrix(c(enr_a, enr_c, enr_b, enr_d), nrow = 2, ncol = 2)
colnames(enr_matrix) <- c("In Pathway", "Not in Pathway")
rownames(enr_matrix) <- c("Entangled", "Not Entangled")
enr_table            <- as.table(enr_matrix)

png(filename = "figures/enriched_mosaic.png")
par(pty = "s") 
mosaicplot(t(enr_table), 
           col = c("firebrick", "goldenrod1"), 
           cex.axis = 1, 
           sub = "Pathway Status", 
           ylab = "Entanglement Status", 
           main = enr_pathway)
dev.off()

# depleted pathway
dep_pathway <- "R-HSA-202733"
dep_a <- depleted %>% 
         dplyr::filter(unique_pathways == dep_pathway) %>%
         .$a_in_pathway_entangled

dep_b <- depleted %>% 
         dplyr::filter(unique_pathways == dep_pathway) %>%
         .$b_out_pathway_entangled

dep_c <- depleted %>% 
         dplyr::filter(unique_pathways == dep_pathway) %>%
         .$c_in_pathway_not_entangled

dep_d <- depleted %>% 
         dplyr::filter(unique_pathways == dep_pathway) %>%
         .$d_out_pathway_not_entangled

dep_matrix           <- matrix(c(dep_a, dep_c, dep_b, dep_d), nrow = 2, ncol = 2)
colnames(dep_matrix) <- c("In Pathway", "Not in Pathway")
rownames(dep_matrix) <- c("Entangled", "Not Entangled")
dep_table            <- as.table(dep_matrix)

png(filename = "figures/depleted_mosaic.png")
par(pty = "s") 
mosaicplot(t(dep_table), 
           col = c("firebrick", "goldenrod1"),
           cex.axis = 1, 
           sub = "Pathway Status", 
           ylab = "Entanglement Status", 
           main = dep_pathway)
dev.off()